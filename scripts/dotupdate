#!/bin/bash

OLDWD=$PWD
cd $HOME/dotfiles
git pull

# No forced pins (prevents typing it 4 times)
gpg --card-edit / admin forcesig quit

# Import gpg data (might be refreshed on other pc's)
#gpg --output - --decrypt secrets/gpg-pubkeyring.gpg | gpg --import
#gpg --output - --decrypt secrets/gpg-ownertrust.gpg | gpg --import-ownertrust

gpg --keyserver hkp://keys.techwolf12.nl/ --refresh-keys

# Export the data again
gpg --export-ownertrust | gpg --batch --yes --output secrets/gpg-ownertrust.gpg --sign --encrypt
gpg -a --output /tmp/pubkeys.asc --export
gpg --batch --yes --output secrets/gpg-pubkeyring.gpg --sign --encrypt /tmp/pubkeys.asc
gpg -a --batch --yes --output gnupg/2F2546D8.asc --export 0x2F2546D8

# Password database (still need to find a merge way before pulling that)
gpg --batch --yes --output secrets/pass.gpg --sign --encrypt secrets/keepass.kdb

cp $HOME/.mozilla/firefox/b6qhetnq.default/stylish.sqlite  misc/firefox.stylish/stylish.sqlite

git add secrets/gpg-pubkeyring.gpg secrets/gpg-ownertrust.gpg secrets/pass.gpg gnupg/2F2546D8.asc misc/firefox.stylish/stylish.sqlite
git commit -m "Automatic dotupdate $(date +"%m-%d-%Y %r")"
git push


if [ -d /home/techwolf12/scripts ] ; then
    for file in /home/techwolf12/scripts/*; do
        sudo ln -sf $file /usr/bin/.;
    done
fi

# Force the pins again
gpg --card-edit / admin forcesig quit

cd $OLDWD
