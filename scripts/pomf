#!/bin/bash
# Maintainer: Mirko van der Waal
# Packages: libnotify xclip
# Contact: <mvdw at airmail dot cc>

VERSION=0.2

# Find out that some things aren't working? Follow these stepts to ensure
# I am not at fault.
# 1. Have a internet connection, I know it may sound silly but some people
#    just don't have it or forget that they aren't currently connected.
# 2. Export the $BROWSER variable when using the -w flag. This relies on you
#    exporting that variable to know what browser to force the file in.
# 3. The specified file or paste is not bigger than 50MB or rarely 5MB.
# 4. Make sure the LOCALSAVE and LOGSAVE variable paths are existant.
#    If this is not the case moving the file could cause problems to the script.
# 5. Don't forget to install the required packages, the names may vary
#    for the different operating systems.

# Throw the file here for a normal upload.
UPLOADURL="http://pomf.se/upload.php"    
# Save a local copy of the file here.
LOCALSAVE=$HOME/Pictures/pomfs          
# Write the url to this file to keep track.
LOGSAVE=$HOME/Pictures/pomfs/url.list   

# You can change these values to set the defaults.
FORCETOWWW=false    
UPLOADFILE=false    
FULLSCREEN=false    
SELECTION=false     

while getopts fhswvlg:u: flag; do
    case $flag in
        l) BOOL_LOCALSAVE=true  ;;
        g) BOOL_LOGSAVE=true
           COMM_LOGSAVE=$OPTARG ;;
        f) FULLSCREEN=true      ;;
        w) FORCETOWWW=true      ;;
        s) SELECTION=true       ;;
        u) UPLOADFILE=true      
           FILEARG=$OPTARG      ;;
        v) echo $VERSION; exit  ;;
        h) echo "
$(tput bold)NAME$(tput sgr0)
    Pomfsh - Upload a file not limited to any .extension to http://pomf.se

$(tput bold)FLAGS$(tput sgr0)
    $(tput bold)-u$(tput sgr0)
        Upload the <argument> file. This throws away the \`-s\` & \`-f\` flags.
        You can however save the file locally and write it to the logfile.
        
    $(tput bold)-f$(tput sgr0)
        Create a fullscreen screenshot, this takes a screenshot of all the-
        available and active monitors. If you want to take a screenshot of only-
        the current window. You can use \`-s\` to select the entire screen.

    $(tput bold)-s$(tput sgr0)
        Take a selection based screenshot. Select an area with the mouse after-
        the script is ran. Release to automatically upload the data.

    $(tput bold)-w$(tput sgr0)
        This will open the just created screenshot or already existant file-
        in the browser that is exported as \$BROWSER.

    $(tput bold)-g$(tput sgr0)
        Write the succesfully uploaded url to the \$LOGSAVE variable path.
        You can optionally specify a message to be added along with the url-
        to easily identify it later. This is optional however.

    $(tput bold)-l$(tput sgr0)
        Make a local copy of the screenshot, this is rather useless with the-
        \`-u\` flag as that assumes you already HAVE an copy of the file. 

    $(tput bold)-h$(tput sgr0)
        Display this.

    $(tput bold)-v$(tput sgr0)
        Show the current version.

$(tput bold)ISSUES$(tput sgr0)
    The following points are also addressed in the source of the code.
    But made available through the \`-h\` flag.
    
    *  Have a internet connection, I know it may sound silly but some people
       just don't have it or forget that they aren't currently connected.

    *  Export the \$BROWSER variable when using the -w flag. This relies on you
       exporting that variable to know what browser to force the file in.

    *  The specified file or paste is not bigger than 50MB or rarely 5MB.

    *  Make sure the \$LOCALSAVE and \$LOGSAVE variable paths are existant.
       If this is not the case moving the file could cause problems to the script.

    *  Don't forget to install the required packages, the names may vary
       for the different operating systems.

$(tput bold)EXAMPLES$(tput sgr0)
    % pomf -wsgl
        A complete package allowing selection and saving the files to both-
        the logs and locally.
    % pomf -sg "My terminal"
        Allow a selection screenshot and write to the logfile with the-
        <argument> comment next to it.
    % pomf -f 
        Quickly take a screenshot of your screens but don't do anything else.
        "; exit ;;
    esac
done

# Get the current file.
if [[ $FULLSCREEN = true ]]; then :
    FILE=$(NAME=$(echo -n $$.png); scrot $NAME; echo -n $NAME)
elif [[ $SELECTION = true ]]; then :
    FILE=$(NAME=$(echo -n $$.png); scrot -s $NAME; echo -n $NAME)
elif [[ $UPLOADFILE = true ]]; then :
    FILE=$FILEARG
else
    echo "You either forgot a to specify a file or a -flag. "
    exit
fi

# Upload the file
if [[ $UPLOADFILE = true || $FULLSCREEN = true || $SELECTION = true ]]; then :
    OUTPUT=$(curl --silent -sf -F files[]="@$FILE" $UPLOADURL)
    if [[ ${OUTPUT} =~ '"success":true' ]]; then :
        URL=$(echo "$OUTPUT" | grep -Eo '"url":"[A-Za-z0-9]+.*",' | \
                               sed 's/"url":"//;s/",//')
    
        notify-send http://a.pomf.se/$URL
         
        [[ $BOOL_LOCALSAVE = true ]] && mv $FILE $LOCALSAVE/$URL || rm $FILE
        [[ $BOOL_LOGSAVE = true ]] && echo http://a.pomf.se/$URL \
                                      \# $COMM_LOGSAVE >> $LOGSAVE
        [[ $FORCETOWWW = true ]] && $BROWSER http://a.pomf.se/$URL
        
        echo -n $URL | xclip -selection primary     &>/dev/null
        echo -n $URL | xclip -selection clipboard   &>/dev/null

        echo "Succesfully uploaded: http://a.pomf.se/$URL"

    else
        echo "You failed to upload the file ($FILE)"
        exit
    fi
else
    echo "You're a fucking wizard you fucking know that?!"
fi
